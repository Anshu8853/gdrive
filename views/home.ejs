<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>GDrive - Welcome</title>
    <style>
        body { font-family: Arial; background: #f0f0f0; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: 30px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 10px; }
        .welcome-text { text-align: center; color: #666; margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        input[type=file] { 
            width: 100%; 
            padding: 15px; 
            border: 2px dashed #007bff; 
            border-radius: 8px; 
            box-sizing: border-box; 
            background: #f8f9ff;
            text-align: center;
            cursor: pointer;
        }
        input[type=file]:hover { background: #e6f3ff; }
        button { width: 100%; background: #007bff; color: white; padding: 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-bottom: 15px; }
        button:hover { background: #0056b3; }
        .logout-btn { background: #6c757d; width: auto; padding: 8px 16px; font-size: 14px; float: right; }
        .logout-btn:hover { background: #545b62; }
        .success { background: #d4edda; color: #155724; padding: 12px; margin-bottom: 20px; border-radius: 4px; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; color: #721c24; padding: 12px; margin-bottom: 20px; border-radius: 4px; border-left: 4px solid #dc3545; }
        .file-section { margin-top: 40px; padding-top: 30px; border-top: 1px solid #dee2e6; }
        .file-section h2 { color: #333; margin-bottom: 20px; }
        .file-item { 
            background: #f8f9fa; 
            padding: 15px; 
            margin-bottom: 10px; 
            border-radius: 4px; 
            border: 1px solid #dee2e6; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .file-info { flex: 1; }
        .file-name { color: #333; font-weight: 500; margin-bottom: 3px; }
        .file-date { color: #666; font-size: 12px; }
        .file-actions { display: flex; gap: 8px; align-items: center; }
        .view-btn { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 6px 12px; 
            border-radius: 4px; 
            text-decoration: none; 
            font-size: 12px; 
            cursor: pointer;
        }
        .view-btn:hover { background: #0056b3; color: white; }
        .delete-btn { 
            background: #dc3545; 
            color: white; 
            border: none; 
            padding: 6px 12px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 12px; 
        }
        .delete-btn:hover { background: #c82333; }
        .no-files { text-align: center; color: #666; padding: 30px; background: #f8f9fa; border-radius: 4px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .user-greeting { color: #333; font-size: 18px; }
        .admin-link { color: #007bff; text-decoration: none; font-size: 14px; }
        .admin-link:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="user-greeting">
                <strong>Welcome, <%= user.username %>!</strong>
                <% if (user.role === 'admin') { %>
                <br><a href="/admin/dashboard" class="admin-link"> Admin Dashboard</a>
                <% } %>
            </div>
            <a href="/user/logout">
                <button type="button" class="logout-btn">Logout</button>
            </a>
        </div>
        
        <h1>GDrive File Storage</h1>
        <p class="welcome-text">Upload and manage your files securely in the cloud</p>
        
        <% if (typeof success !== 'undefined' && success) { %>
        <div class="success">
            <strong> Success:</strong> <%= success %>
        </div>
        <% } %>
        
        <% if (typeof error !== 'undefined' && error) { %>
        <div class="error">
            <strong> Error:</strong> <%= error %>
        </div>
        <% } %>
        
        <form action="/user/upload" method="POST" enctype="multipart/form-data" onsubmit="return validateFile()">
            <div class="form-group">
                <label for="file">🗂️ Choose File to Upload</label>
                <input type="file" id="file" name="file" required accept=".jpg,.jpeg,.png,.pdf,.txt,.doc,.docx">
                <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                    Supported formats: JPG, PNG, PDF, TXT, DOC, DOCX (Max: 10MB)
                </small>
            </div>
            
            <button type="submit">📤 Upload File</button>
        </form>
        
        <script>
        function validateFile() {
            const fileInput = document.getElementById('file');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file to upload!');
                return false;
            }
            
            // Check file size (10MB limit)
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                alert('File size must be less than 10MB!');
                return false;
            }
            
            return true;
        }
        </script>
        
        <div class="file-section">
            <h2> Your Files (<%= user.files ? user.files.length : 0 %>)</h2>
            
            <% if (user.files && user.files.length > 0) { %>
                <% user.files.forEach(function(file) { %>
                <div class="file-item">
                    <div class="file-info">
                        <div class="file-name">
                            <% if (typeof file === 'string') { %>
                                <%= file %>
                            <% } else if (file.originalName) { %>
                                <%= file.originalName %>
                            <% } else if (file.filename) { %>
                                <%= file.filename %>
                            <% } else { %>
                                Unknown file
                            <% } %>
                        </div>
                        <% if (file.uploadDate || (typeof file === 'object' && file.uploadDate)) { %>
                        <div class="file-date">
                            Uploaded: <%= new Date(file.uploadDate).toLocaleDateString() %>
                        </div>
                        <% } %>
                    </div>
                    <div class="file-actions">
                        <% 
                        let fileUrl = '';
                        let fileId = '';
                        
                        if (typeof file === 'string') {
                            // Old format - file is just a string (public_id)
                            fileUrl = `https://res.cloudinary.com/${cloudinaryCloudName}/image/upload/${file}`;
                            fileId = file;
                        } else if (file.cloudinaryUrl) {
                            // New format - file has cloudinaryUrl
                            fileUrl = file.cloudinaryUrl;
                            fileId = file.filename || file.publicId;
                        } else if (file.filename) {
                            // New format without cloudinaryUrl - construct URL
                            fileUrl = `https://res.cloudinary.com/${cloudinaryCloudName}/image/upload/${file.filename}`;
                            fileId = file.filename;
                        } else if (file.publicId) {
                            // Use publicId
                            fileUrl = `https://res.cloudinary.com/${cloudinaryCloudName}/image/upload/${file.publicId}`;
                            fileId = file.publicId;
                        }
                        %>
                        <% if (fileUrl) { %>
                        <a href="<%= fileUrl %>" 
                           target="_blank" class="view-btn">
                            View
                        </a>
                        <% } %>
                        <form action="/user/delete-file" method="POST" style="display: inline;">
                            <input type="hidden" name="filename" value="<%= fileId %>">
                            <button type="submit" class="delete-btn" onclick="return confirm('Are you sure you want to delete this file?')">
                                Delete
                            </button>
                        </form>
                    </div>
                </div>
                <% }); %>
            <% } else { %>
                <div class="no-files">
                     No files uploaded yet<br>
                    <small style="color: #999;">Upload your first file using the form above!</small>
                </div>
            <% } %>
        </div>
    </div>
</body>
</html>